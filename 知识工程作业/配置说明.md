# 程序调试与配置说明

## 已修复的问题

### 1. Windows路径分隔符问题
**问题**：代码中使用了Linux风格的路径分隔符 `/`，在Windows系统下会导致路径错误。

**修复**：
- `build_medicalgraph.py`: 将 `'/'.join(os.path.abspath(__file__).split('/')[:-1])` 改为 `os.path.dirname(os.path.abspath(__file__))`
- `question_classifier.py`: 同样修复路径处理，并使用 `os.path.join()` 代替字符串拼接
- `prepare_data/build_data.py`: 修复路径处理

### 2. 文件编码问题
**问题**：文件打开时未指定编码，在Windows系统下可能出现编码错误。

**修复**：
- 所有 `open()` 调用都添加了 `encoding='utf-8'` 参数
- 包括：
  - `build_medicalgraph.py`: 读取JSON文件和写入文件时
  - `question_classifier.py`: 读取词典文件时
  - `prepare_data/max_cut.py`: 读取词典文件时
  - `prepare_data/build_data.py`: 读取文件时

### 3. 依赖包管理
**创建文件**：`requirements.txt`
- py2neo>=2021.2.3
- pyahocorasick>=2.0.0 (注意：pip包名是pyahocorasick，但导入时使用ahocorasick)
- pymongo>=4.0.0
- lxml>=4.6.0

## 使用步骤

### 第一步：安装依赖
```bash
cd QAMedicalKG
pip install -r requirements.txt
```

### 第二步：启动Neo4j数据库
1. 下载并安装Neo4j：https://neo4j.com/download/
2. 启动Neo4j服务
3. 默认连接配置：
   - **浏览器访问地址**：http://localhost:7474（仅用于浏览器访问）
   - **Python 连接地址**：bolt://localhost:7687（代码中必须使用此地址）
   - 用户名：neo4j
   - 密码：tangyudiadid0

### 第三步：构建知识图谱（首次运行前必须）
```bash
python build_medicalgraph.py
```
这将从 `data/medical2.json` 读取数据并构建Neo4j知识图谱。

**注意**：如果数据量较大，此过程可能需要较长时间。

### 第四步：测试程序
```bash
python test_import.py
```
这将检查所有模块是否能正常导入。

### 第五步：运行问答系统
```bash
python chatbot_graph.py
```

## 配置文件说明

### Neo4j连接配置
如果需要修改Neo4j连接配置，请编辑以下文件：

**⚠️ 重要：新版 py2neo 必须使用 bolt 协议，不能使用 http 协议！**

1. **build_medicalgraph.py** (第10行)
```python
self.g = Graph("bolt://localhost:7687", auth=("neo4j", "tangyudiadid0"))
```

2. **answer_search.py** (第5行)
```python
self.g = Graph("bolt://localhost:7687", auth=("neo4j", "tangyudiadid0"))
```

**配置说明：**
- **协议和端口**：必须使用 `bolt://localhost:7687`（Neo4j 的 Bolt 协议端口）
  - ❌ 错误：`http://localhost:7474`（这是浏览器访问地址，不能用于 Python 连接）
  - ✅ 正确：`bolt://localhost:7687`（Python 连接必须用 Bolt 协议）
- **认证方式**：使用 `auth=("用户名", "密码")` 元组
  - ❌ 错误：`username="neo4j", password="xxx"`（旧版格式，已不支持）
  - ✅ 正确：`auth=("neo4j", "tangyudiadid0")`（新版格式）

## 常见问题排查

### 问题1：ModuleNotFoundError
**解决方案**：
```bash
pip install -r requirements.txt
```

### 问题2：Neo4j连接失败
**检查项**：
- Neo4j服务是否已启动（浏览器访问 http://localhost:7474 能打开说明已启动）
- **端口号是否正确**：
  - Python 连接必须用 **7687 端口**（Bolt 协议）
  - 浏览器访问用 **7474 端口**（HTTP 协议）
- 用户名和密码是否正确
- 防火墙是否阻止连接
- **连接格式是否正确**：
  - ✅ 正确：`Graph("bolt://localhost:7687", auth=("neo4j", "密码"))`
  - ❌ 错误：`Graph("http://localhost:7474", username="neo4j", password="密码")`

### 问题3：文件找不到错误
**检查项**：
- 确保 `data/medical2.json` 文件存在
- 确保 `dict/` 目录下所有词典文件存在
- 确保在正确的目录下运行程序

### 问题4：编码错误
**说明**：所有文件编码问题已修复，如果仍出现编码错误，请检查：
- 系统默认编码设置
- 文件是否真的是UTF-8编码

## 项目文件说明

### 核心文件
- `chatbot_graph.py`: 主程序入口
- `question_classifier.py`: 问题分类器（识别问题类型）
- `question_parser.py`: 问题解析器（生成Cypher查询）
- `answer_search.py`: 答案搜索器（执行查询并格式化答案）
- `build_medicalgraph.py`: 知识图谱构建脚本

### 数据文件
- `data/medical2.json`: 医疗知识数据（JSON格式，每行一个疾病对象）
- `dict/`: 词典目录，包含各种实体词典

### 辅助文件
- `requirements.txt`: Python依赖列表
- `test_import.py`: 测试脚本
- `README.md`: 使用说明文档

## 测试建议

运行程序前，建议先运行测试脚本：
```bash
python test_import.py
```

如果测试通过，说明：
- ✓ 所有依赖已正确安装
- ✓ 项目模块可以正常导入
- ✓ 词典文件可以正常读取

**注意**：测试脚本不会连接Neo4j数据库，所以即使Neo4j未启动也能通过测试。

## 下一步

1. 确保Neo4j数据库已启动
2. 运行 `build_medicalgraph.py` 构建知识图谱
3. 运行 `chatbot_graph.py` 开始使用问答系统

## 技术支持

如果遇到其他问题，请检查：
1. Python版本（建议3.6+）
2. 所有依赖是否正确安装
3. Neo4j数据库是否正常运行
4. 数据文件是否存在且格式正确

