# 功能集成说明

## 📋 概述

已成功将补充资料中的所有功能集成到现有医药问答系统中。系统现在支持更丰富的实体类型、关系类型和问题类型。

---

## ✨ 新增功能

### 1. **新增实体类型**

- **PatientAttribute（病人属性）**：儿童、老年、孕妇等
- **Component（成份）**：药物成份
- **Location（部位）**：身体部位
- **AdverseReaction（不良反应）**：药物不良反应
- **Precaution（注意事项）**：药物注意事项

### 2. **新增关系类型**

- **taboo（禁忌）**：药物禁忌关系
- **adverse_reaction（不良反应）**：药物不良反应关系
- **precaution（注意事项）**：药物注意事项关系
- **special_population（特殊人群用药）**：儿童/老年/妇女用药关系
- **contains（包含）**：药物包含成份关系
- **leads_to（导致）**：症状导致疾病关系
- **includes（包括）**：科室/部位包括疾病/症状关系

### 3. **新增问题类型**

#### 药物相关查询
- **drug_taboo**：药物禁忌查询
  - 示例："阿司匹林有什么禁忌？"
  - 示例："布洛芬不能和什么一起吃？"

- **drug_adverse_reaction**：药物不良反应查询
  - 示例："阿司匹林有什么不良反应？"
  - 示例："布洛芬有什么副作用？"

- **drug_precaution**：药物注意事项查询
  - 示例："阿司匹林有什么注意事项？"
  - 示例："布洛芬需要注意什么？"

- **drug_special_population**：特殊人群用药查询
  - 示例："阿司匹林儿童能用吗？"
  - 示例："布洛芬孕妇能用吗？"
  - 示例："阿司匹林老人能用吗？"

- **drug_component**：药物成份查询
  - 示例："阿司匹林含有什么成份？"
  - 示例："布洛芬有什么成分？"

- **component_drug**：已知成份查药物
  - 示例："含有阿司匹林的药有哪些？"

#### 症状相关查询
- **symptom_lead_disease**：症状导致疾病查询
  - 示例："发烧会导致什么疾病？"
  - 示例："咳嗽会引起什么病？"

#### 科室/部位相关查询
- **department_entity**：科室查询疾病/症状
  - 示例："心内科看什么病？"
  - 示例："内科有什么疾病？"

- **location_entity**：部位查询疾病/症状
  - 示例："头部容易得什么病？"
  - 示例："胸部有什么疾病？"

---

## 🚀 使用步骤

### 第一步：构建基础知识图谱

```bash
python build_medicalgraph.py
```

这会从 `data/medical2.json` 构建基础知识图谱。

### 第二步：导入增强数据

```bash
python import_enhanced_data.py
```

这会从补充资料中导入：
- 禁忌关系（从寻医问药数据）
- 不良反应、注意事项、特殊人群用药（从好心情数据）
- 症状导致疾病关系
- 科室-部位层级结构

**注意**：确保补充资料路径正确：
- `../医疗知识图谱/KG_demo代码/data/xunyiwenyao/寻医问药中药品名的禁忌关系.csv`
- `../医疗知识图谱/KG_demo代码/data/haoxinqing/好心情_全部.xlsx`
- `../医疗知识图谱/KG_demo代码/data/symptom_lead_disease/求医网中症状导致疾病层级结构.txt`
- `../医疗知识图谱/KG_demo代码/data/xunyiwenyao/寻医问药--科室--疾病.txt`
- 等等

### 第三步：运行问答系统

```bash
python chatbot_graph.py
```

---

## 📝 文件说明

### 新增文件

1. **import_enhanced_data.py**
   - 从补充资料导入增强数据到Neo4j知识图谱
   - 支持禁忌关系、不良反应、注意事项等数据导入

2. **dict/component.txt**
   - 药物成份字典（可手动添加或从数据中提取）

3. **dict/location.txt**
   - 身体部位字典

### 修改文件

1. **question_classifier.py**
   - 添加了新的疑问词识别
   - 添加了新的问题类型分类

2. **question_parser.py**
   - 添加了新的SQL查询生成逻辑

3. **answer_search.py**
   - 添加了新的答案格式化函数

---

## ⚠️ 注意事项

1. **数据路径**
   - 确保补充资料路径正确
   - 如果路径不同，请修改 `import_enhanced_data.py` 中的 `base_path`

2. **Neo4j连接**
   - 确保Neo4j数据库已启动
   - 默认连接：`bolt://localhost:7687`
   - 默认用户名：`neo4j`
   - 默认密码：`tangyudiadid0`
   - 如需修改，请编辑相关文件中的连接配置

3. **数据格式**
   - 补充资料的数据格式可能与系统不完全匹配
   - 如果导入失败，请检查数据文件格式和列名

4. **字典文件**
   - `component.txt` 和 `location.txt` 可以手动添加实体
   - 建议从补充资料中提取实体并添加到字典文件

---

## 🧪 测试示例

运行系统后，可以尝试以下问题：

```
咨询: 阿司匹林有什么禁忌？
咨询: 布洛芬有什么不良反应？
咨询: 阿司匹林儿童能用吗？
咨询: 布洛芬含有什么成份？
咨询: 发烧会导致什么疾病？
咨询: 心内科看什么病？
咨询: 头部容易得什么病？
```

---

## 📊 数据统计

导入增强数据后，知识图谱将包含：

- **更多实体类型**：PatientAttribute、Component、Location等
- **更多关系类型**：taboo、adverse_reaction、precaution等
- **更丰富的查询能力**：支持10+种新问题类型

---

## 🔧 故障排除

### 问题1：导入数据失败

**原因**：数据文件路径不正确或文件不存在

**解决**：
1. 检查补充资料路径是否正确
2. 确认数据文件是否存在
3. 检查文件编码格式

### 问题2：查询无结果

**原因**：数据未正确导入或实体名称不匹配

**解决**：
1. 确认数据已成功导入
2. 检查实体名称是否与字典文件匹配
3. 在Neo4j浏览器中验证数据

### 问题3：编码错误

**原因**：文件编码格式不匹配

**解决**：
- 代码已自动处理多种编码格式
- 如果仍有问题，请检查文件编码并转换

---

## 📞 后续优化建议

1. **数据质量**
   - 定期更新和清洗数据
   - 验证实体名称一致性

2. **性能优化**
   - 优化Cypher查询语句
   - 添加索引以提高查询速度

3. **功能扩展**
   - 支持更多问题类型
   - 添加模糊匹配功能
   - 支持多轮对话

---

*集成完成时间：2024年*
*版本：增强版 v1.0*

